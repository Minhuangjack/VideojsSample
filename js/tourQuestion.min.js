var $mediaPlayer,$memoDialog,$questionDialog,sourceAvailable;$(function(){function v(){var t=this;t.questions=ko.observableArray(n);t.type="影片";t.canScroll=!0;t.canReply=ko.observable(!0);t.questionCount=ko.computed(function(){return"("+t.questions().length+")"});t.afterAddEvent=function(n){var i,r;if(t.canScroll&&n.nodeType===1&&$(n).hasClass("media")&&($(".new").removeClass("new"),$(n).addClass("new"),i=!1,!i)){f.on("scroll mousedown DOMMouseScroll mousewheel keyup",function(){f.stop()});r=$(n).offset().top;f.animate({scrollTop:r},500,function(){i=!0;f.off("scroll mousedown DOMMouseScroll mousewheel keyup")})}};t.setPosition=function(n){return $mediaPlayer.setPosition(n.Question_Position),!1};t.replyQuestionNo=undefined;t.replyQuestion=function(n){t.replyQuestionNo=n;i&&$.contains(document.body,i[0])&&t.edit(i.data("question"),undefined,!0);r.remove();r=$(s);r.insertAfter($('[data-no="'+n.Question_No+'"]').last());r.find("textarea").autosize().focus();var e=r.offset().top,u=!1;if(!u){f.on("scroll mousedown DOMMouseScroll mousewheel keyup",function(){f.stop()});f.animate({scrollTop:e},500,function(){u=!0;f.off("scroll mousedown DOMMouseScroll mousewheel keyup")})}return StartAjax("ClearQuestionAttachment",{},function(n){n.Success_Mark||alert(n.Display_Message)}),!1};t.forwardQuestion=function(n){StartAjax("ForwardQuestion",{Question_No:n.Question_No},function(n){if(n.Success_Mark)OpenDialogForDisplay("/A00D_Information/A00D_M31_SendMessage.aspx","TitleName="+encodeURIComponent("A00D_M31　轉寄訊息"),2,660);else{alert(n.Display_Message);return}})};t.followQuestion=function(n,t){if(t.stopPropagation&&t.stopPropagation(),!$(t.target?t.target:t.srcElement).is(":disabled")){var i=!n.Follow_Mark();return i?n.Follow_Nos(n.Follow_Nos()+1):n.Follow_Nos(n.Follow_Nos()-1),StartAjax("SetFollowMark",{Question_No:n.Question_No,Follow_Mark:i},function(t){if(t.Success_Mark)n.Follow_Mark(i);else if(t.Display_Message!=""){alert(t.Display_Message);return}}),!1}};t.category=function(i,f){return f.stopPropagation&&f.stopPropagation(),OpenDialogForDisplay("/L10B_Briefing/L10B030_F3_Category.aspx","TitleName="+encodeURIComponent("L10B030_F3　問題歸檔")+"&QuestionNo="+i.Question_No,2,600),StartAjax("GetQuestion",{Doc_No:u.Doc_No},function(i){if(i.Success_Mark){r.remove();n=i.Response_Data.Question;for(var u=0,f=n.length;u<f;u++)n[u].Follow_Mark=ko.observable(n[u].Follow_Mark),n[u].Follow_Nos=ko.observable(n[u].Follow_Nos),n[u].Question_Content=ko.observable(n[u].Question_Content),n[u].Modify_Time=ko.observable(n[u].Modify_Time),n[u].Attachment=ko.observableArray(n[u].Attachment);t.questions(n);$(".new").removeClass("new");n.length==0?$(".loading-snack").removeClass("loading-snack").text("沒有問答資料"):($(".loading-snack").remove(),$("#questionWrap").removeClass("hide"))}else{alert(i.Display_Message);return}},!0),!1};t.readMore=function(n,t){t.stopPropagation&&t.stopPropagation();var i=$(t.target?t.target:t.srcElement);return i.prev().html(n.Question_Content()),i.hide(),!1};t.edit=function(n,t,u){var s=$("#q"+n.Question_No),o=s.find(".question-content"),f,e;if(i&&$.contains(document.body,i[0])){if(f=i.data("question"),u){$("#q"+f.Question_No).find(".question-content").show();i.remove();return}if(n.Question_No===f.Question_No)return;$("#q"+f.Question_No).find(".question-content").show();i.remove()}if(!n.Modify_Mark){alert("您無法編輯此問題內容");return}r.remove();o.hide();i=$(a);i.data("question",n);e=i.find("textarea");StartAjax("GetQuestionContent",{Question_No:n.Question_No},function(t){var u,f,r,s;if(t.Success_Mark){i.insertAfter(o);e.val("").focus().val(t.Response_Data.c).autosize();u=$(h);for(f in t.Response_Data.attach)r=t.Response_Data.attach[f],s='<a data-no="'+r.n+'" data-path="'+r.p+'" style="position:relative" href="'+gvWebPicPath+r.p+'" rel="edit-group'+n.Question_No+'"><button style="position:absolute;left:0" title="刪除" type="button" class="close">&times;<\/button><img src="'+gvWebPicPath+r.p+'" rel="" /><\/a>',u.find("ul").append("<li>"+s+"<\/li>");u.insertAfter(e)}else alert(t.Display_Message)})}}function y(n,t){var u=[],f,i,r;for(f in n){i={};for(r in t)i[t[r]]=n[f][r];u.push(i)}return u}var t,n,e,o,l;$("form").submit(function(){return!1});$(document.body).on("dragstart",function(){return!1});$(".container").width()>550&&$(".container").width(550);var u=$("#hdVideoData").val()==""?null:JSON.parse($("#hdVideoData").val()),s='<div id="replyForm" class="question reply"><div class="media msg"><div class="media-body text-right"><textarea placeholder="請輸入回覆內容" class="form-control col-lg-12" id="txtReplyContent"><\/textarea><div class="pull-left help-block"><\/div><a title="插入圖片" class="atch picture pull-left" style="text-decoration:none" href="javascript://">&nbsp;<\/a><input style="margin-right:2px" data-role="sendReply" type="button" value="送出" class="btn btn-primary btn-xs"/><\/div><\/div><hr /><\/div>',r=$(s),a='<div class="editForm"><div class="msg"><div class="media-body text-right"><textarea class="form-control col-lg-12 input-content"><\/textarea><div class="pull-left help-block"><\/div><a title="插入圖片" class="atch picture pull-left" style="text-decoration:none" href="javascript://">&nbsp;<\/a><input style="margin-right:2px" data-role="sendEdit" type="button" value="送出" class="btn btn-primary btn-xs"/><input style="margin-right:2px" type="button" value="取消" class="btn btn-default btn-xs"/><\/div><\/div>',i,h='<div class="text-right pics"><ul><\/ul><\/div>',f=$("html, body"),p=$(".settings"),c=$(".tooltab");if(u){e=$("#txtQuestionContent");e.autosize().height(20);StartAjax("GetQuestion",{Doc_No:u.Doc_No},function(i){var u,o,f,s,e;if(i.Success_Mark){for(n=i.Response_Data.Question,u=0,o=n.length;u<o;u++)n[u].Follow_Mark=ko.observable(n[u].Follow_Mark),n[u].Follow_Nos=ko.observable(n[u].Follow_Nos),n[u].Question_Content=ko.observable(n[u].Question_Content),n[u].Modify_Time=ko.observable(n[u].Modify_Time),n[u].Attachment=ko.observableArray(n[u].Attachment);if(n.length==0?$(".progress").removeClass("loading-snack").text("沒有問答資料"):($(".loading-snack").remove(),$("#questionWrap").removeClass("hide")),t===undefined?(t=new v,ko.applyBindings(t)):(t.canScroll=!1,t.questions(i.Question),t.canScroll=!0),t.canReply(!0),r.remove(),c.is(":visible")||c.show(),location.hash!==""&&(f=location.hash.substring(1),f.indexOf("q")==0)){try{s=parseInt(location.hash.substring(1))}catch(h){return}e=$("#"+f);e.addClass("new");$("#content").scrollTop(e.offset().top)}$(".pics a").colorbox({maxHeight:"90%",maxWidth:"90%"})}else{alert(i.Display_Message);return}},!0);$("#cmdSendQuestion").click(function(){var r=$(this),h=r.data("role"),i,s;e===undefined&&(e=$("#txtQuestionContent"));var n=$.trim(e.val()),f=n.length,o=n.match(/\n/g);if(o&&(f+=o.length),f>500){alert("問題內容請勿超過 500 個字");return}if(n.length==0){alert("請輸入問題內容");return}r.prop("disabled",!0);i=0;s={Doc_No:u.Doc_No,Question_Position:i,Question_Content:n,Reply_Question_No:0};StartAjax("NewQuestion",s,function(n){var o,h,c;if(n.Success_Mark){$(".video-question-group .nodata").hide();var f=n.Response_Data,l=i.toString().toHHMMSS(),s=0;for(o=0,h=t.questions().length;o<h;o++)if(c=t.questions()[o],!c.Top_Mark){s=o;break}$(".progress")&&($(".progress").remove(),$("#questionWrap").removeClass("hide"));t.questions.splice(s,0,{Doc_No:u.Doc_No,Reply_Mark:!1,Manage_Mark:!0,Modify_Mark:!0,Modify_Time:ko.observable(),Attach_Mark:f.am,Attachment:ko.observableArray(f.at),Position_Text:l,Question_Position:i,Question_Content:ko.observable(f.c),Question_No:f.n,Input_User:f.u,Input_Name:f.a,Input_Time:f.t,User_Photo:f.p,Reply_Question_No:f.n,Follow_Mark:ko.observable(null),Follow_Nos:ko.observable(0),Top_Mark:f.top})}else alert(n.Display_Message);r.prop("disabled",!1);e.val("").next().html("")},!0)});o=$(".question-tips");$("#txtQuestionContent").focus(function(){o.is(":visible")&&o.hide()}).blur(function(){var n=$(this);$.trim(n.val())===""&&o.show()});$(document).on("click",'[data-role="cola-user"]',function(n){n.preventDefault();var t=$(this),i=t.attr("data-user-id");OpenDialogForDisplay("/A00B_Enterprise/A00B_Q02_UserData.aspx","TitleName="+encodeURIComponent("A00B_Q02　員工資料查詢")+"&UserId="+i,2,540)});$(document).on("click",'[data-role="sendReply"]',function(n){var f,i,h;if(n.preventDefault(),f=$(this),f.prop("disable",!0),i=t.replyQuestionNo.Question_No,i&&i!==0){var e=$.trim($("#txtReplyContent").val()),o=e.length,s=f.val().match(/\n/g);if(s&&(o+=s.length),e.length===0)return alert("請輸入回覆內容"),!1;if(o>500)return alert("回覆請勿輸入超過 500 個字"),!1;h={Doc_No:u.Doc_No,Question_Position:0,Question_Content:e,Reply_Question_No:i};StartAjax("NewQuestion",h,function(n){var e,c,h,o,l,s;if(n.Success_Mark){for(e=n.Response_Data,h=0,o=0,l=t.questions().length;o<l;o++)s=t.questions()[o],s.Reply_Question_No==i&&s.Question_No>h&&(h=s.Question_No,c=o);t.questions.splice(c+1,0,{Doc_No:u.Doc_No,Reply_Mark:!0,Attach_Mark:e.am,Attachment:ko.observableArray(e.at),Manage_Mark:!0,Modify_Mark:!0,Modify_Time:ko.observable(),Position_Text:"",Question_Position:0,Question_Content:ko.observable(e.c),Question_No:e.n,Input_User:e.u,Input_Name:e.a,Input_Time:e.t,User_Photo:e.p,Reply_Question_No:i,Follow_Mark:ko.observable(null),Follow_Nos:ko.observable(0),Top_Mark:t.replyQuestionNo.Top_Mark});e.am&&$('[rel="group'+e.n+'"]').colorbox({maxHeight:"90%",maxWidth:"90%"});r.remove()}else alert(n.Display_Message),f.prop("disabled",!1)},!0)}});$(document).on("click",'.editForm input[type="button"]',function(){var r=$(this),e=i.find("textarea"),n=i.data("question");if(r.data("role")==="sendEdit"){var f=$.trim(e.val()),o=f.length,s=e.val().match(/\n$/g);if(s&&(o+=s.length),f.length===0)return alert("請輸入回覆內容"),!1;if(o>500)return alert("回覆請勿輸入超過 500 個字"),!1;r.prop("disabled",!0);StartAjax("ModifyQuestion",{Doc_No:u.Doc_No,Question_No:n.Question_No,Question_Content:f},function(i){if(i.Success_Mark){var u=i.Response_Data;n.Question_Content(u.c);n.Modify_Time(u.t);n.Attachment(u.attach)}else alert(i.Display_Message);r.prop("disabled",!1);t.edit(n,undefined,!0)})}else t.edit(n,undefined,!0)});l={p:"path",n:"no"};$(document).on("click",".atch",function(){var t=OpenDialogForDisplay("/L10B_Briefing/L10B_S1_SearchPictureObject.aspx","TitleName="+encodeURIComponent("L10B_S1 搜尋圖片元件"),2,700);if(t!==undefined){var n=$(this),i=JSON.parse(t),r=n.attr("id");StartAjax("HandleQuestionAttachment",{Attach_Files:i,New_Question:!!r},function(t){var u,f;if(t.Success_Mark){u=y(t.Response_Data.attachs,l);for(f in u){var i=u[f],e='<a data-no="'+i.no+'" data-path="'+i.path+'" style="position:relative" href="'+gvWebPicPath+i.path+'"><button style="position:absolute;left:0" title="刪除" type="button" class="close">&times;<\/button><img src="'+gvWebPicPath+i.path+'" /><\/a>',r=n.siblings(".pics");r.length==0&&(r=$(h),r.insertAfter(n.siblings("textarea")));r.find("ul").append("<li>"+e+"<\/li>")}}else t.Display_Message&&alert(t.Display_Message)})}});$(document).on("click",".pics .close",function(n){n.stopPropagation();var t=$(this),i=t.parents(".pics"),r=t.parent().data("path"),u=t.parents("#questionForm")==1;StartAjax("RemoveQuestionAttachment",{File_Type:"IMAGE",File_Path:r,New_Question:u},function(n){n.Success_Mark?t.parents("li:first").fadeOut(200,function(){$(this).remove();i.find("li").length==0&&(i.remove(),i=null)}):n.Display_Message&&alert(n.Display_Message)})});$(document).on("click",".modifyLog",function(n){var i=$(this),t=i.attr("href").substring(1);n.preventDefault();StartAjax("GetQuestionLog",{Question_No:t},function(n){var e,i,r,o,s,u,f;if(n.Success_Mark){e=n.Response_Data.d;i="";i+='<div style="width: 350px; margin: 10px;">';for(u in e){if(r=e[u],o=r.Attachment_Paths,i+='<div class="question">',i+='<div class="media msg">',i+='<a class="pull-left media-left" href="#" data-role="cola-user" data-user-id="'+r.Original_User+'">',i+='<img class="media-object" style="width: 32px;" src="'+r.User_Photo+'">',i+="<\/a>",i+='<div class="media-body">',i+='<small class="pull-right time" title="發表時間">'+r.Original_Time+"<\/small>",i+='<div class="media-heading">',i+='<a href="#" data-role="cola-user" data-user-id="'+r.Original_User+'">'+r.Original_Name+"<\/a>",i+='<div class="question-content">',i+="<span>"+r.Question_Content+"<\/span>",o!==""){i+='<div class="pics"><ul>';s=o.split("；");for(u in s)(f=s[u],f!=="")&&(i+='<li><a href="'+gvWebPicPath+f+'" rel="group'+t+'"><img src="'+gvWebPicPath+f+'" /><\/a><\/li>');i+="<\/ul><\/div>"}i+="<\/div>";i+="<\/div>";i+="<\/div>";i+="<\/div>"}i+="<\/div>";$.colorbox({html:i,opacity:.5})}else n.Display_Message&&alert(n.Display_Message)})});$(document).on("click",".pics a",function(n){n.preventDefault();var t=$(this);$.colorbox({href:t.attr("href"),maxHeight:"90%",maxWidth:"90%"})})}});
/*
//# sourceMappingURL=tourQuestion.min.js.map
*/