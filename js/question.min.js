$(function(){function h(){StartAjax("GetQuestionForManage",{Doc_No:r.Doc_No},function(t){var f,u,o;if(t.Success_Mark){if(i===undefined){for(n=t.Response_Data.Question,u=0,o=n.length;u<o;u++)n[u].Follow_Mark=ko.observable(n[u].Follow_Mark),n[u].Follow_Nos=ko.observable(n[u].Follow_Nos),n[u].Question_Content=ko.observable(n[u].Question_Content),n[u].Modify_Time=ko.observable(n[u].Modify_Time),n[u].Attachment=ko.observableArray(n[u].Attachment),isNaN(e)||n[u].Question_No==e&&(f=n[u]);i=new y;i.type=r.Doc_Type;ko.applyBindings(i)}n.length==0?$(".loading-snack").removeClass("loading-snack").text("沒有問答資料"):($(".loading-snack").remove(),$("#questionWrap").removeClass("hide"));!isNaN(e)&&f&&(a?i.edit(f,undefined):i.replyQuestion(f),location.hash="#q"+e);$(".pics a").colorbox()}else{alert(t.Display_Message);return}},!0)}function y(){var i=this;i.questions=ko.observableArray(n);i.type="影片";i.canScroll=!0;i.canReply=ko.observable(!0);i.questionCount=ko.computed(function(){return"("+i.questions().length+")"});i.afterAddEvent=function(n){var t,r;if(i.canScroll&&n.nodeType===1&&$(n).hasClass("media")&&($(".new").removeClass("new"),$(n).addClass("new"),t=!1,!t)){u.on("scroll mousedown DOMMouseScroll mousewheel keyup",function(){u.stop()});r=$(n).offset().top;u.animate({scrollTop:r},500,function(){t=!0;u.off("scroll mousedown DOMMouseScroll mousewheel keyup")})}};i.setPosition=function(n){return $mediaPlayer.setPosition(n.Question_Position),!1};i.replyQuestionNo=undefined;i.replyQuestion=function(n){i.replyQuestionNo=n;t&&$.contains(document.body,t[0])&&i.edit(t.data("question"),undefined,!0);f.remove();f=$(o);f.insertAfter($('[data-no="'+n.Question_No+'"]').last());f.find("textarea").autosize().focus();var e=f.offset().top,r=!1;if(!r){u.on("scroll mousedown DOMMouseScroll mousewheel keyup",function(){u.stop()});u.animate({scrollTop:e},500,function(){r=!0;u.off("scroll mousedown DOMMouseScroll mousewheel keyup")})}return StartAjax("ClearQuestionAttachment",{},function(n){n.Success_Mark||alert(n.Display_Message)}),!1};i.forwardQuestion=function(n){StartAjax("ForwardQuestion",{Question_No:n.Question_No},function(n){if(n.Success_Mark)OpenDialogForDisplay("/A00D_Information/A00D_M31_SendMessage.aspx","TitleName="+encodeURIComponent("A00D_M31　轉寄訊息"),2,660);else{alert(n.Display_Message);return}})};i.followQuestion=function(n,t){if(t.stopPropagation&&t.stopPropagation(),!$(t.target?t.target:t.srcElement).is(":disabled")){var i=!n.Follow_Mark();return i?n.Follow_Nos(n.Follow_Nos()+1):n.Follow_Nos(n.Follow_Nos()-1),StartAjax("SetFollowMark",{Question_No:n.Question_No,Follow_Mark:i},function(t){if(t.Success_Mark)n.Follow_Mark(i);else if(t.Display_Message!=""){alert(t.Display_Message);return}}),!1}};i.category=function(t,u){return u.stopPropagation&&u.stopPropagation(),OpenDialogForDisplay("/L10B_Briefing/L10B030_F3_Category.aspx","TitleName="+encodeURIComponent("L10B030_F3　問題歸檔")+"&QuestionNo="+t.Question_No,2,600),StartAjax("GetQuestionForManage",{Doc_No:r.Doc_No},function(t){if(t.Success_Mark){f.remove();n=t.Response_Data.Question;for(var r=0,u=n.length;r<u;r++)n[r].Follow_Mark=ko.observable(n[r].Follow_Mark),n[r].Follow_Nos=ko.observable(n[r].Follow_Nos),n[r].Question_Content=ko.observable(n[r].Question_Content),n[r].Modify_Time=ko.observable(n[r].Modify_Time),n[r].Attachment=ko.observableArray(n[r].Attachment);i.questions(n);$(".new").removeClass("new");n.length==0?$(".loading-snack").removeClass("loading-snack").text("沒有問答資料"):($(".loading-snack").remove(),$("#questionWrap").removeClass("hide"))}else{alert(t.Display_Message);return}},!0),!1};i.readMore=function(n,t){t.stopPropagation&&t.stopPropagation();var i=$(t.target?t.target:t.srcElement);return i.prev().html(n.Question_Content()),i.hide(),!1};i.edit=function(n,i,r){var h=$("#q"+n.Question_No),o=h.find(".question-content"),u,e;if(t&&$.contains(document.body,t[0])){if(u=t.data("question"),r){$("#q"+u.Question_No).find(".question-content").show();t.remove();return}if(n.Question_No===u.Question_No)return;$("#q"+u.Question_No).find(".question-content").show();t.remove()}if(!n.Modify_Mark){alert("您無法編輯此問題內容");return}f.remove();o.hide();t=$(l);t.data("question",n);e=t.find("textarea");StartAjax("GetQuestionContent",{Question_No:n.Question_No},function(i){var u,f,r,h;if(i.Success_Mark){t.insertAfter(o);e.val("").focus().val(i.Response_Data.c).autosize();u=$(s);for(f in i.Response_Data.attach)r=i.Response_Data.attach[f],h='<a data-no="'+r.n+'" data-path="'+r.p+'" style="position:relative" href="'+gvWebPicPath+r.p+'" rel="edit-group'+n.Question_No+'"><button style="position:absolute;left:0" title="刪除" type="button" class="close">&times;<\/button><img src="'+gvWebPicPath+r.p+'" rel="" /><\/a>',u.find("ul").append("<li>"+h+"<\/li>");u.insertAfter(e)}else alert(i.Display_Message)})}}function p(n,t){var u=[],f,i,r;for(f in n){i={};for(r in t)i[t[r]]=n[f][r];u.push(i)}return u}var u=$("html, body"),o='<div id="replyForm" class="question reply"><div class="media msg"><div class="media-body text-right"><textarea placeholder="請輸入回覆內容" class="form-control col-lg-12" id="txtReplyContent"><\/textarea><div class="pull-left help-block"><\/div><a title="插入圖片" class="atch picture pull-left" style="text-decoration:none" href="javascript://">&nbsp;<\/a><input style="margin-right:2px" data-role="sendReply" type="button" value="送出" class="btn btn-primary btn-xs"/><\/div><\/div><hr /><\/div>',l='<div class="editForm"><div class="msg"><div class="media-body text-right"><textarea class="form-control col-lg-12 input-content"><\/textarea><div class="pull-left help-block"><\/div><a title="插入圖片" class="atch picture pull-left" style="text-decoration:none" href="javascript://">&nbsp;<\/a><input style="margin-right:2px" data-role="sendEdit" type="button" value="送出" class="btn btn-primary btn-xs"/><input style="margin-right:2px" type="button" value="取消" class="btn btn-default btn-xs"/><\/div><\/div>',f=$(o),t,s='<div class="text-right pics"><ul><\/ul><\/div>',r=$("#hdVideoData").val()==""?null:JSON.parse($("#hdVideoData").val()),e=r.QuestionNo,a=r.TxCode,v=r.Doc_Type,i,n,c;v==="影片"?$mediaPlayer=$("#mediaPlayer").mediaplayer({onLoaded:function(){$mediaPlayer.setSource({videoId:r.Video_Id,sourceType:"briefing",learnerMark:!1,onComplete:function(n){r=n;h()}})},onPlayEnded:function(n){n||r.Doc_Type==="產品"&&$mediaPlayer.get(0).Content.Player.SetMediaSource("http://ntestmedia.colatour.com.tw/Cola_MediaFiles/inproc/pd_notfound.mp4",0,!1)},learnerMark:!1}):($(".left_contain").remove(),$(".right_contain").removeClass("col-xs-6"),$(".container").width(600),h());$(document).on("click",'[data-role="cola-user"]',function(n){n.preventDefault();var t=$(this),i=t.attr("data-user-id");OpenDialogForDisplay("/A00B_Enterprise/A00B_Q02_UserData.aspx","TitleName="+encodeURIComponent("A00B_Q02　員工資料查詢")+"&UserId="+i,2,540)});$(document).on("click",'[data-role="sendReply"]',function(n){var u,t,h;if(n.preventDefault(),u=$(this),u.prop("disable",!0),t=i.replyQuestionNo.Question_No,t&&t!==0){var e=$.trim($("#txtReplyContent").val()),o=e.length,s=u.val().match(/\n/g);if(s&&(o+=s.length),e.length===0)return alert("請輸入回覆內容"),!1;if(o>500)return alert("回覆請勿輸入超過 500 個字"),!1;h={Doc_No:r.Doc_No,Question_Position:0,Question_Content:e,Reply_Question_No:t};StartAjax("NewQuestion",h,function(n){var e,c,h,o,l,s;if(n.Success_Mark){for(e=n.Response_Data,h=0,o=0,l=i.questions().length;o<l;o++)s=i.questions()[o],s.Reply_Question_No==t&&s.Question_No>h&&(h=s.Question_No,c=o);i.questions.splice(c+1,0,{Doc_No:r.Doc_No,Reply_Mark:!0,Attach_Mark:e.am,Attachment:ko.observableArray(e.at),Manage_Mark:!0,Modify_Mark:!0,Modify_Time:ko.observable(),Position_Text:"",Question_Position:0,Question_Content:ko.observable(e.c),Question_No:e.n,Input_User:e.u,Input_Name:e.a,Input_Time:e.t,User_Photo:e.p,Reply_Question_No:t,Follow_Mark:ko.observable(null),Follow_Nos:ko.observable(0),Top_Mark:i.replyQuestionNo.Top_Mark,cancel:e.cancel});e.am&&$('[rel="group'+e.n+'"]').colorbox();f.remove()}else alert(n.Display_Message),u.prop("disabled",!1)},!0)}});$(document).on("click",'.editForm input[type="button"]',function(){var u=$(this),e=t.find("textarea"),n=t.data("question");if(u.data("role")==="sendEdit"){var f=$.trim(e.val()),o=f.length,s=e.val().match(/\n$/g);if(s&&(o+=s.length),f.length===0)return alert("請輸入回覆內容"),!1;if(o>500)return alert("回覆請勿輸入超過 500 個字"),!1;u.prop("disabled",!0);StartAjax("ModifyQuestion",{Doc_No:r.Doc_No,Question_No:n.Question_No,Question_Content:f},function(t){if(t.Success_Mark){var r=t.Response_Data;n.Question_Content(r.c);n.Modify_Time(r.t);n.Attachment(r.attach)}else alert(t.Display_Message);u.prop("disabled",!1);i.edit(n,undefined,!0)})}else i.edit(n,undefined,!0)});c={p:"path",n:"no"};$(document).on("click",".atch",function(){var t=OpenDialogForDisplay("/L10B_Briefing/L10B_S1_SearchPictureObject.aspx","TitleName="+encodeURIComponent("L10B_S1 搜尋圖片元件"),2,700);if(t!==undefined){var n=$(this),i=JSON.parse(t),r=n.attr("id");StartAjax("HandleQuestionAttachment",{Attach_Files:i,New_Question:!!r},function(t){var u,f;if(t.Success_Mark){u=p(t.Response_Data.attachs,c);for(f in u){var i=u[f],e='<a data-no="'+i.no+'" data-path="'+i.path+'" style="position:relative" href="'+gvWebPicPath+i.path+'"><button style="position:absolute;left:0" title="刪除" type="button" class="close">&times;<\/button><img src="'+gvWebPicPath+i.path+'" /><\/a>',r=n.siblings(".pics");r.length==0&&(r=$(s),r.insertAfter(n.siblings("textarea")));r.find("ul").append("<li>"+e+"<\/li>")}}else t.Display_Message&&alert(t.Display_Message)})}});$(document).on("click",".pics .close",function(n){n.stopPropagation();var t=$(this),i=t.parents(".pics"),r=t.parent().data("path"),u=t.parents("#questionForm")==1;StartAjax("RemoveQuestionAttachment",{File_Type:"IMAGE",File_Path:r,New_Question:u},function(n){n.Success_Mark?t.parents("li:first").fadeOut(200,function(){$(this).remove();i.find("li").length==0&&(i.remove(),i=null)}):n.Display_Message&&alert(n.Display_Message)})});$(document).on("click",".modifyLog",function(n){var i=$(this),t=i.attr("href").substring(1);n.preventDefault();StartAjax("GetQuestionLog",{Question_No:t},function(n){var e,i,r,o,s,u,f;if(n.Success_Mark){e=n.Response_Data.d;i="";i+='<div style="width: 350px; margin: 10px;">';for(u in e){if(r=e[u],o=r.Attachment_Paths,i+='<div class="question">',i+='<div class="media msg">',i+='<a class="pull-left media-left" href="#" data-role="cola-user" data-user-id="'+r.Original_User+'">',i+='<img class="media-object" style="width: 32px;" src="'+r.User_Photo+'">',i+="<\/a>",i+='<div class="media-body">',i+='<small class="pull-right time" title="發表時間">'+r.Original_Time+"<\/small>",i+='<div class="media-heading">',i+='<a href="#" data-role="cola-user" data-user-id="'+r.Original_User+'">'+r.Original_Name+"<\/a>",i+='<div class="question-content">',i+="<span>"+r.Question_Content+"<\/span>",o!==""){i+='<div class="pics"><ul>';s=o.split("；");for(u in s)(f=s[u],f!=="")&&(i+='<li><a href="'+gvWebPicPath+f+'" rel="group'+t+'"><img src="'+gvWebPicPath+f+'" /><\/a><\/li>');i+="<\/ul><\/div>"}i+="<\/div>";i+="<\/div>";i+="<\/div>";i+="<\/div>"}i+="<\/div>";$.colorbox({html:i,opacity:.5})}else n.Display_Message&&alert(n.Display_Message)})});$(document).on("click",".pics a",function(n){n.preventDefault();var t=$(this);$.colorbox({href:t.attr("href")})})});
/*
//# sourceMappingURL=question.min.js.map
*/